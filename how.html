<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How Does It Work ? &mdash; Impunity 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=2709fde1"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/design-tabs.js?v=36754332"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Performance Analysis" href="perf_improvement.html" />
    <link rel="prev" title="The Annotated object" href="annotated.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Impunity
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Annotations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="string_annotation.html">String Annotations</a></li>
<li class="toctree-l1"><a class="reference internal" href="annotated.html">The Annotated object</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Topic</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">How Does It Work ?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#reminder-on-decorators">Reminder on Decorators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="perf_improvement.html">Performance Analysis</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Contribute to impunity</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Impunity</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">How Does It Work ?</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/how.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-does-it-work">
<h1>How Does It Work ?<a class="headerlink" href="#how-does-it-work" title="Link to this heading"></a></h1>
<section id="reminder-on-decorators">
<h2>Reminder on Decorators<a class="headerlink" href="#reminder-on-decorators" title="Link to this heading"></a></h2>
<p>In Python, a decorator function in Python is a higher order function which changes the behaviour
of a given function. Let’s consider an illustrative code snippet to understand how impunity operates
in practice. Suppose we have the following Python function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">speed</span><span class="p">(</span><span class="n">distance</span><span class="p">:</span> <span class="s2">&quot;meters&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="s2">&quot;seconds&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;km/h&quot;</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">duration</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>If we use the following decorator function, at definition time, the following code is executed and the
same function is returned:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function definition for </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">function</span>

<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">speed</span><span class="p">(</span><span class="n">distance</span><span class="p">:</span> <span class="s2">&quot;meters&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="s2">&quot;seconds&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;km/h&quot;</span><span class="p">:</span>
    <span class="o">...</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">decorator</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
<span class="n">Function</span> <span class="n">definition</span> <span class="k">for</span> <span class="n">speed</span>
</pre></div>
</div>
<p>In practice, decorator functions are mostly used to change the behaviour of functions at runtime. A
common example is the logging of the execution of a function, or the timing of its execution. Then
a new (nested) function must be defined based on the old one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">new_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing function </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with parameters </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_function</span>

    <span class="nd">@logger</span>
    <span class="k">def</span> <span class="nf">speed</span><span class="p">(</span><span class="n">distance</span><span class="p">:</span> <span class="s2">&quot;meters&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="s2">&quot;seconds&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;km/h&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">duration</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="o">&gt;&gt;&gt;</span> <span class="n">speed</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Executing</span> <span class="n">function</span> <span class="n">speed</span> <span class="k">with</span> <span class="n">parameters</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="mf">0.5</span>
</pre></div>
</div>
<p>The impunity library provides the &#64;impunity decorator in order to check the coherence of physical
units defined within the code: it traverses (and sometimes modifies) the Abstract Syntax Tree (AST)
of the code for the function. Annotated variables and functions are logged for future reference. The
AST of our speed function can be depicted in a visual representation, as shown below:</p>
<figure class="align-default" id="base-ast">
<img alt="_images/ast_origin.svg" src="_images/ast_origin.svg" /></figure>
<p>As the decorator function walks through the AST, variables annotated with units of measures (i.e.
distance and duration) are logged. Then, each time a call to an annotated function is detected,
&#64;impunity compares the expected units of measures from function parameters and return values with
the units specified in the function definition. When a mismatch is detected, indicating an
inconsistency in units, impunity takes one of the following actions:</p>
<ul class="simple">
<li><p>if the two units are commensurable, &#64;impunity modifies the AST to include a conversion operation;</p></li>
<li><p>if the two units are not commensurable, an IncommensurableUnits warning is raised.</p></li>
</ul>
<figure class="align-default" id="diagram">
<img alt="_images/test.svg" src="_images/test.svg" /></figure>
<p>In the case of the speed function example, the expected return UoM is “km/h” while the UoM inferred
from the division between distance and duration variables is “m/s”. impunity identifies this discrepancy
and takes action by modifying the AST accordingly. It introduces a binary operation (BinOp)
node to convert the result to the proper UoM, as depicted in red on this modified AST:</p>
<figure class="align-default" id="modif-ast">
<img alt="_images/ast_modif.svg" src="_images/ast_modif.svg" /></figure>
<p>Here, the constant value of 3.6 is calculated by determining the conversion factor between the two
units “m/s” and “km/h”. Here, impunity leverages the capabilities of the sister Pint library: however,
the Pint functionalities are called only once at definition time, and not at runtime (i.e. every time
the function is executed) resulting in a tremendous gain in performance.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="annotated.html" class="btn btn-neutral float-left" title="The Annotated object" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="perf_improvement.html" class="btn btn-neutral float-right" title="Performance Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Antoine Chevrot.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>